
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Klavierlern‑App</title>
  <style>
    /* Blinker-Cursor für Chat-Intro */
    .cursor-dot {
      display: inline-block;
      width: 0.6rem;
      height: 0.6rem;
      background-color: #000;
      border-radius: 50%;
      margin-left: 0.2rem;
      animation: blink 1s step-start infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    /* Chat-Zeilen für Intro und allgemeine Chat-Zeilen */
    .chat-line {
      margin: 0.3rem 0;
      transition: opacity 0.4s, max-height 0.4s, margin 0.4s, transform 0.4s;
      max-height: 100px;
      overflow: hidden;
    }
    .faded-line {
      opacity: 0.5;
    }
    .active-line {
      opacity: 1;
    }

    /* Grundlegendes Layout und Typografie */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      color: #000000;
    }

    /* Begrüßungs‑Overlay */
    #intro {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #ffffff;
      z-index: 999;
      padding: 2rem;
      font-size: 5rem;
      box-sizing: border-box;
    }
    #intro.hidden {
      display: none;
    }
    #messages {
      margin-bottom: 1rem;
      font-size: 2.2rem;
      font-weight: bold;
      line-height: 1.4;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 100%;
      max-width: 800px;
    }
    #name-input {
      visibility: hidden;
      border: none;
      outline: none;
      background: transparent;
      font-size: 2.2rem;
      font-weight: bold;
      color: #000;
      line-height: 1.4;
      margin: 0;
      vertical-align: baseline;
      display: inline-block;
      padding: 0;
      height: auto;
      font-family: inherit;
      min-width: auto;
      flex: none;
      box-sizing: content-box;
      transition: width 0.2s ease;
    }

      .input-line {
        display: inline-flex;
        align-items: center;   /* statt baseline */
        width: auto;
      }

      #intro button {
        background-color: #000;
        color: #fff;
        border: none;
        border-radius: 2rem;
        padding: 0.5rem 1rem;
        margin-left: 0.5rem;
        cursor: pointer;
        font-size: 1rem;     /* etwas näher an der Input-Schriftgröße */
        line-height: 1.4;
        transition: background 0.15s, color 0.15s;
        align-items: center;   /* <- Semikolon nicht vergessen */
      }
    #intro button:hover,
    #intro button:focus {
      background-color: #222;
      color: #fff;
    }

    /* Hauptbereich */
    #main {
      display: none;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 1rem;
      
    }
    #greeting {
      font-size: 5.2rem;
      font-weight: bold;
    }

    /* Notationsbereich */
    #notation-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      box-sizing: border-box;
    }
    #notation {
      width: 100%;
      max-width: 600px;
      height: 200px;
    }

    /* Steuerungsbuttons */
    #controls {
      padding: 1rem;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      border-top: 1px solid #e0e0e0;
    }
    button.position-btn {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background-color: transparent;
      border: 1px solid #000;
      cursor: pointer;
    }
    button.position-btn.active {
      background-color: #000;
      color: #fff;
    }
    button.position-btn:hover,
    button.position-btn:focus {
      background-color: #fff;
      color: #000;
    }
    #status-message {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.9rem;
      min-height: 1.5rem;
    }
      
      .chat-line {
        margin: 0.3rem 0;
        max-height: 100px;
        overflow: hidden;
        transition: transform 0.4s ease, opacity 0.4s ease;
      }

      /* Neue Animation für nach oben rutschen */
      .shift-up {
        transform: translateY(-120%);
        opacity: 0;
      }
      
      #notation {
          width: 80vw;
        max-width: 80%;
        height: auto;
        transform: scale(1.2); /* 120% Zoom */
        transform-origin: center;
      }
      #notation svg {
        width: 100%;
        height: auto;
      }
      
      #position-selector {
        display: flex;
        justify-content: center;
        gap: 1rem;
        padding: 1rem;
      }

      .pos-btn {
        position: relative;
        width: 20px;
        height: 20px;
        background: #000;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      /* Aktiver Button zeigt Buchstaben in der Pille */
      .pos-btn.active::before {
        content: attr(data-pos);
        color: #fff;
        font-size: 0.9rem;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }

      /* Aktiver Button = gestreckte Linie */
      .pos-btn.active {
        width: 60px;
        border-radius: 1rem;
      }

      /* Plus-Button bleibt immer ein Kreis mit zentriertem Plus */
      .plus-btn {
        width: 20px !important;
        height: 20px !important;
        border-radius: 50% !important;
        font-size: 1rem;
        font-weight: bold;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .plus-btn.active {
        width: 20px !important;
        border-radius: 50% !important;
      }
      .plus-btn::before {
        content: none; /* verhindert Anzeige von data-pos im Inneren */
      }
      
      .note-range {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2rem;
        gap: 1rem;
      }
      .note-control {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .note-control button.arrow {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
      }
      
      </style>
</head>
<body>
  <!-- Begrüßungs‑Overlay -->
  <div id="intro">
    <div class="chat-container">
      <div id="messages"></div>
      <div class="input-line">
        <input id="name-input" type="text" placeholder="Name" />
        <button id="name-ok" style="display:none;">OK</button>
      </div>
      <div id="tutorial-choice" style="display:none;"></div>
    </div>
  </div>

  
 <script>

      // Lade gespeicherten Namen und Skill‑Daten aus localStorage
      function getStoredName() {
        try {
          return localStorage.getItem('username');
        } catch (e) {
          return null;
        }
      }
      function setStoredName(name) {
        try {
          localStorage.setItem('username', name);
        } catch (e) {}
      }

      // Tutorial-Übung Steuerung
      let tutorialExerciseActive = false;
      let expectedSequence = [];
      let sequenceIndex = 0;



      // Chat‑ähnliche Begrüßung
      const introMessages = [
        'Hallo! Ich bin Finn',
        'Ich unterstütze dich beim Lernen der Noten',
        'Wie heißt du?'
      ];
      let introIndex = 0;
      function typeMessage(message, callback, withCursorDot = true) {
        let i = 0;
        // Vor neuer Zeile: alle bisherigen Zeilen ausblenden (50%)
        Array.from(messagesEl.children).forEach(child => {
          child.classList.remove('active-line');
          child.classList.add('faded-line');
        });
        // Neue Zeile für die Nachricht
        const lineDiv = document.createElement('div');
        lineDiv.classList.add('chat-line', 'active-line');
        // Cursor-Element erzeugen
        let cursor = null;
        // Cursor-dot immer zu Beginn sichtbar, wenn gewünscht
        if (withCursorDot) {
          cursor = document.createElement('span');
          cursor.className = 'cursor-dot';
          lineDiv.appendChild(cursor); // Erstmal nur Cursor, Text wird hinzugefügt
        }
        messagesEl.appendChild(lineDiv);
        // Setze Text dynamisch vor dem Cursor
        const interval = setInterval(() => {
          // Füge nächsten Buchstaben vor dem Cursor ein
          if (cursor) {
            cursor.before(document.createTextNode(message.charAt(i)));
          } else {
            lineDiv.appendChild(document.createTextNode(message.charAt(i)));
          }
          i++;
          if (i >= message.length) {
            clearInterval(interval);
            // Cursor-dot IMMER nach Tipp-Ende entfernen, egal ob withCursorDot true oder false
            if (cursor) {
              cursor.remove();
            }
            // Neue Logik: Chat-Zeilen-Begrenzung nach vollständigem Schreiben
            enforceMaxChatLines();
            setTimeout(() => callback && callback(), 600);
          }
        }, 40);
      }

      // Begrenzung der Chat-Zeilen: entfernt die erste Zeile mit Fade-Out-Animation, sobald mehr als max Zeilen vorhanden sind
      function enforceMaxChatLines(max = 4) {
        if (messagesEl.children.length > max) {
          const first = messagesEl.firstElementChild;
          if (first) {
            first.classList.add('shift-up');
            first.addEventListener('transitionend', () => {
              if (first.parentElement === messagesEl) {
                messagesEl.removeChild(first);
              }
            }, { once: true });
          }
        }
      }

      // Funktion moveCursorDotToInput entfernt, da Cursor-Dot nicht mehr zu Input verschoben wird

      function runIntro() {
        if (introIndex < introMessages.length) {
          const msg = introMessages[introIndex];
          introIndex++;
          // Nur für reine Chat-Nachrichten (ohne Buttons/Input): withCursorDot true
          // Bei der letzten Nachricht (vor Input) KEIN cursor-dot mehr, da danach Input erscheint
          if (introIndex === introMessages.length) {
            // Letzte Zeile vor Input: KEIN cursor-dot
            typeMessage(msg, runIntro, false);
          } else {
            typeMessage(msg, runIntro, true);
          }
        } else {
          // Nach der letzten Nachricht das Eingabefeld und OK-Button anzeigen, OHNE cursor-dot verschieben
          nameInputEl.style.visibility = 'visible';
          nameOkBtn.style.display = 'inline-block';
          nameInputEl.addEventListener('input', function() {
            const len = Math.max(nameInputEl.value.length, nameInputEl.placeholder.length);
            nameInputEl.style.width = len + 'ch';
          });
        }
      }

      // Tutorial-Choice anzeigen
      function showTutorialChoice(name) {
        // Neue Chat-Nachricht: Möchtest du ein Tutorial ansehen? (ohne cursor-dot, da Buttons erscheinen)
        typeMessage(`${name}, sollen wir dir zeigen, wie die App funktioniert?`, () => {
          tutorialChoiceEl.style.display = 'block';
          tutorialChoiceEl.innerHTML = `
            <button id="tutorial-yes">Gerne!</button>
            <button id="tutorial-no">Ich war schon mal hier.</button>
          `;
          // Event-Listener für Ja/Nein
          document.getElementById('tutorial-yes').addEventListener('click', () => {
            tutorialChoiceEl.style.display = 'none';
            runTutorial(name);
          });
          document.getElementById('tutorial-no').addEventListener('click', () => {
            tutorialChoiceEl.style.display = 'none';
            enterMain(name);
          });
        }, false);
      }

      // Tutorial-Funktion
      function runTutorial(name, index = 0) {
        const tutorialMessages = [
          "Alles klar! Das Prinzip ist ganz einfach",
          "Im Notensystem erscheint jeweils eine Note, die du auf deinem Keyboard spielen sollst.",
          "Du erhältst umgehend Feedback",
          "Beüben kannst du alle festen Lagen, den Quintenzirkel und mehr.",
          "Viel Spaß beim Ausprobieren!"
        ];
        if (index < tutorialMessages.length - 2) {
          typeMessage(tutorialMessages[index], () => runTutorial(name, index + 1), false);
        } else if (index === 3) {
          // Nach dieser Nachricht: Übungsfunktion starten, dann mit nächster Nachricht fortfahren
          typeMessage(tutorialMessages[index], () => {
            startTutorialExercise();
            runTutorial(name, index + 1);
          }, false);
        } else if (index === tutorialMessages.length - 1) {
          // Letzte Tutorial-Nachricht, dann Button anzeigen
          typeMessage(tutorialMessages[index], () => {
            tutorialChoiceEl.style.display = 'block';
            tutorialChoiceEl.innerHTML = `
              <button id="tutorial-finish">love it!</button>
            `;
            document.getElementById('tutorial-finish').addEventListener('click', () => {
              tutorialChoiceEl.style.display = 'none';
              enterMain(name);
            });
          }, false);
        }
      }

      function startTutorialExercise() {
        expectedSequence = ['C4','D4','E4','C4'];
        sequenceIndex = 0;
        tutorialExerciseActive = true;

        // Notensystem mit C, D, E, F anzeigen
        notationEl.innerHTML = '';
        const VF = window.VexFlow || (window.Vex ? window.Vex.Flow : null);
        if (!VF) {
          notationEl.textContent = 'VexFlow konnte nicht geladen werden.';
          return;
        }

        const vf = new VF.Factory({renderer: {elementId: 'notation', width: 500, height: 200}});
        const score = vf.EasyScore();
        const system = vf.System();
        const notes = score.notes('C4/q, D4/q, E4/q, F4/q');
        const voice = score.voice(notes);
        system.addStave({voices:[voice]}).addClef('treble').addTimeSignature('4/4');
        vf.draw();

        statusMessageEl.textContent = "Spiele C, D, E und dann nochmal C!";
      }

      function enterMain(name) {
        introEl.classList.add('hidden');
        mainEl.style.display = 'flex';
        // greetingEl.textContent = `Hallo, ${name}!`; // Begrüßungstext entfernt
        setPosition(currentPosition);
        renderInitialStaff();
        initMIDI();
      }

      // Initialisieren
      function init() {
        const storedName = getStoredName();
        if (storedName) {
          // Name vorhanden: Zeige Begrüßung mit Tipp-Animation und gehe dann automatisch in den Hauptbereich
          introEl.classList.remove('hidden');
          mainEl.style.display = 'none';
          messagesEl.innerHTML = '';
          // Input und Buttons ausblenden
          nameInputEl.style.display = 'none';
          nameOkBtn.style.display = 'none';
          tutorialChoiceEl.style.display = 'none';
          // Begrüßung mit Animation in zwei getrennten Nachrichten
          typeMessage(`Hallo, ${storedName}.`, () => {
            typeMessage(`Willkommen zurück!`, () => {
              setTimeout(() => enterMain(storedName), 700);
            }, false);
          }, false);
        } else {
          // Begrüßung anzeigen und Intro starten
          introEl.classList.remove('hidden');
          runIntro();
        }
      }

      // Event‑Listener für Namenseingabe
      function handleNameInput() {
        const name = nameInputEl.value.trim();
        if (name) {
          setStoredName(name);
          // Blende Input und OK aus
          nameInputEl.style.display = 'none';
          nameOkBtn.style.display = 'none';
          // Cursor-Dot ggf. entfernen
          const inputContainer = nameInputEl.parentElement;
          const cursorDot = inputContainer.querySelector('.cursor-dot');
          if (cursorDot) cursorDot.remove();
          showTutorialChoice(name);
        }
      }

      nameInputEl.addEventListener('keypress', function (evt) {
        if (evt.key === 'Enter') {
          handleNameInput();
        }
      });
      nameOkBtn.addEventListener('click', function () {
        handleNameInput();
      });

      // Event‑Listener für Positionsbuttons
      document.querySelectorAll('button.pos-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const pos = btn.getAttribute('data-pos');
          if (pos === 'plus') {
            // Notensystem ausblenden, Range-Selector einblenden
            document.getElementById('notation').style.display = 'none';
            document.getElementById('range-selector').style.display = 'block';
          } else {
            setPosition(pos);
          }
        });
      });

      
  </script>
</body>
</html>

     
