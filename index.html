<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Notentraining</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <style>
    #toolbox {
      width: 92%;
      margin: 20px auto;
      background: #ffffff;
      border: 2px solid #000;
      border-radius: 18px;
      padding: 18px;
      text-align: center;
    }

    .toolbox-header {
      font-size: 1.4em;
      font-weight: 600;
      color: #000;
      margin-bottom: 15px;
      letter-spacing: 0.5px;
    }

    .toolbox-inner {
      background: #fff;
      border-radius: 14px;
      padding: 14px;
      border: 1.5px solid #000;
      position: relative;
    }

    #rangeTrack {
      position: relative;
      display: flex;
      justify-content: space-between;
      padding: 6px;
    }

    #rangeTrack span {
      flex: 1;
      text-align: center;
      cursor: pointer;
      position: relative;
      z-index: 2;
      font-size: 1em;
      font-weight: 500;
      color: #000;
    }

    #rangeIndicator {
      position: absolute;
      top: 3px;
      bottom: 3px;
      width: calc(100% / 5 - 6px);
      background: #000;
      border-radius: 10px;
      transition: transform 0.25s ease;
      z-index: 1;
      opacity: 0.1;
    }

    #rangeTrack .active-range {
      font-weight: 700;
      color: #000;
    }
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      transition: background-color 0.5s;
      background-color: #ffffff;
    }
    h1 {
      margin-top: 20px;
    }
    #notation {
      width: 820px;
      margin: 0 auto;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1.5);
      text-align: center;
      border: none !important;
      padding: 10px;
  }
    /* Styling der Buttons */
    #rangeSelector, #modeSelector, #levelSelector {
      margin: 10px auto;
    }
    #rangeSelector span, #modeSelector span, #levelSelector span {
      cursor: pointer;
      font-size: 1.5em;
      margin: 5px;
      padding: 8px 12px;
      border: none;
      background: none;
      display: inline-block;
    }
    /* Range: schwarzer Text */
    #rangeSelector span {
      color: #000;
      transition: color 0.2s;
    }
    .active-range {
      font-weight: bold;
      color: #000;
    }
    .inactive-range {
      color: #000;
    }
    /* Mode und Level: Standardfarben */
    #modeSelector span, #levelSelector span {
      color: #000;
      padding: 6px 10px;
      margin: 0 4px;
      border-radius: 10px;
      border: 1.5px solid #000;
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .active-mode, .active-level {
      background: none;
      color: #000;
      font-weight: 700;
    }

    .inactive-mode, .inactive-level {
      background: none;
      color: #000;
      opacity: 0.6;
    }
    /* Debug-Ausgabe und Score */
    #nativeLog {
      margin-top: 10px;
      font-size: 0.9em;
      color: gray;
    }
    #score, #responseTime {
      margin-top: 10px;
      font-size: 1.2em;
    }

    #toolbar {
      width: 100%;
      display: flex;
      flex-direction: row; justify-content: center; align-items: center; gap: 12px;
      padding: 28px 0 14px 0;
      background: #fff;
      text-align: center;
    }
    .toolbar-section {
      display: flex;
      justify-content: center;
      gap: 16px;
      padding: 8px 0;
    }
    .toolbar-separator {
      width: 2px;
      height: 24px;
      background: #000;
      margin: 0 10px;
      align-self: center;
    }
  </style>
  
  <!-- Globale Funktionen im Head -->
  <script>
    // Globale Variablen – diese Variablen sind im globalen Scope verfügbar.
    var currentSeries = [];
    var seriesCounter = 0;
    var seriesLength = 10; // Standardmäßig 10 Noten (Level 3)
    var totalAttempts = 0;
    var correctAnswers = 0;
    var level = 3; // Standard: Level 3 (10 Noten)
    var lastStartTime = Date.now();

    // Globale Funktion updateScore
    function updateScore() {
      var scoreElem = document.getElementById("toolbar-score");
      var percent = totalAttempts > 0 ? Math.round((correctAnswers / totalAttempts) * 100) : 0;
      scoreElem.textContent = "Score: " + percent + "%";
    }
    window.updateScore = updateScore;

    // Umrechnung von MIDI Data1 in Notennamen und Oktave
    function midiNoteToName(noteNumber) {
      var noteNames = ['c','c#','d','d#','e','f','f#','g','g#','a','a#','b'];
      var octave = Math.floor(noteNumber / 12) - 1;
      var noteName = noteNames[noteNumber % 12];
      return { note: noteName, octave: octave };
    }

    // Globale Funktion handleMIDIMessage, die von Swift (via evaluateJavaScript) aufgerufen wird.
    window.handleMIDIMessage = function(status, data1, data2) {
      console.log("handleMIDIMessage aufgerufen:", status, data1, data2);
      var nativeLog = document.getElementById("nativeLog");
      nativeLog.textContent = "MIDI: Status " + status + ", Data1 " + data1 + ", Data2 " + data2;
      
      // Nur Note-On Nachrichten verarbeiten (Status 144-159 und velocity > 0)
      if (status >= 144 && status < 160 && data2 > 0) {
        var midiInfo = midiNoteToName(data1);
        console.log("Umgewandelte Note:", midiInfo);
        var now = Date.now();
        var delta = now - lastStartTime;
        lastStartTime = now;

        var icon = "turtle";
        if (delta < 400) icon = "rocket";
        else if (delta < 900) icon = "rabbit";

        var rtElem = document.getElementById("toolbar-speed");
        rtElem.innerHTML = '<i data-lucide="' + icon + '"></i> ' + delta + " ms";
        lucide.createIcons();

        if (seriesCounter < currentSeries.length) {
          var expected = currentSeries[seriesCounter];
          if (midiInfo.note === expected.note && midiInfo.octave === expected.octave) {
            correctAnswers++;
            expected.color = "green";
            nativeLog.textContent += " - Richtig!";
            document.body.style.backgroundColor = "#d4edda"; // Grün
          } else {
            expected.color = "red";
            nativeLog.textContent += " - Falsch!";
            document.body.style.backgroundColor = "#f8d7da"; // Rot
          }
          totalAttempts++;
          window.updateScore();
          seriesCounter++;
          drawSeries();
          // Wenn alle Noten abgearbeitet wurden, neue Serie nach 1 Sekunde erzeugen und Hintergrund zurücksetzen.
          if (seriesCounter >= seriesLength) {
            setTimeout(function() {
              document.body.style.backgroundColor = "#ffffff";
              generateSeries();
            }, 1000);
          }
        }
      }
    };
    // Alias für Swift: handleSwiftMIDI ruft handleMIDIMessage auf
    window.handleSwiftMIDI = function(status, data1, data2) {
      return window.handleMIDIMessage(status, data1, data2);
    };
  </script>
</head>
<body>
  <div id="midiStatus" style="position: absolute; top: 10px; left: 10px; font-size: 1em;"></div>
  
  <div id="toolbar">
    <div id="toolbar-hands" class="toolbar-section">
      <span id="mode-left" class="inactive-mode"><i data-lucide="hand-helping" style="transform: rotate(180deg);"></i></span>
      <span id="mode-right" class="active-mode"><i data-lucide="hand-helping" style="transform: rotate(180deg) scaleX(-1);"></i></span>
      <span id="mode-both" class="inactive-mode"><i data-lucide="dices"></i></span>
    </div>

    <div class="toolbar-separator"></div>

    <div id="toolbar-ranges" class="toolbar-section">
      <span id="range-c" class="active-range">C-Lage</span>
      <span id="range-d" class="inactive-range">D-Lage</span>
      <span id="range-f" class="inactive-range">F-Lage</span>
      <span id="range-g" class="inactive-range">G-Lage</span>
      <span id="range-mc" class="inactive-range">Mittlere C</span>
    </div>

    <div class="toolbar-separator"></div>

    <div id="toolbar-levels" class="toolbar-section">
      <span id="level-1" class="inactive-level"><i data-lucide="tally-1"></i></span>
      <span id="level-2" class="inactive-level"><i data-lucide="tally-2"></i></span>
      <span id="level-3" class="active-level"><i data-lucide="tally-3"></i></span>
    </div>
    <div class="toolbar-separator"></div>
    <div id="toolbar-stats" class="toolbar-section">
      <span id="toolbar-score">Score: 0%</span>
      <span id="toolbar-speed">-- ms</span>
    </div>
  </div>
  
  
  
  <!-- Notensystem, Score, ResponseTime, Debug -->
  <div id="notation"></div>
  <!-- <div id="score">Score: 0%</div> -->
  <!-- <div id="responseTime">-- ms</div> -->
  <div id="nativeLog"></div>
  
  <!-- VexFlow einbinden -->
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
  
  <script>
    // Event Listener: DOMContentLoaded – konfiguriert die UI-Elemente.
    document.addEventListener("DOMContentLoaded", function() {
      // Initiale Serien-Generierung
      generateSeries();
      
      // Konfiguration der Handmodus-Buttons
      var modeButtons = document.querySelectorAll("#toolbar-hands span");
      modeButtons.forEach(function(btn) {
        btn.addEventListener("click", function() {
          modeButtons.forEach(function(b) {
            b.classList.remove("active-mode");
            b.classList.add("inactive-mode");
          });
          btn.classList.remove("inactive-mode");
          btn.classList.add("active-mode");
          generateSeries();
        });
      });
      
      // Konfiguration der Level-Buttons: Ändert den globalen Level-Wert und passt seriesLength an.
      var levelButtons = document.querySelectorAll("#toolbar-levels span");
      levelButtons.forEach(function(btn) {
        btn.addEventListener("click", function() {
          levelButtons.forEach(function(b) {
            b.classList.remove("active-level");
            b.classList.add("inactive-level");
          });
          btn.classList.remove("inactive-level");
          btn.classList.add("active-level");
          if (btn.id === "level-1") {
            level = 1;
          } else if (btn.id === "level-2") {
            level = 2;
          } else if (btn.id === "level-3") {
            level = 3;
          }
          generateSeries();
        });
      });

      var rangeSpans = document.querySelectorAll("#toolbar-ranges span");

      rangeSpans.forEach(function(btn, index) {
        btn.addEventListener("click", function() {
          document.querySelectorAll("#toolbar-ranges span").forEach(s => s.classList.remove("active-range"));
          btn.classList.add("active-range");
          generateSeries();
        });
      });

      lucide.createIcons();

      // GSAP button animations
      document.querySelectorAll("#toolbar-hands span").forEach(btn => {
        btn.addEventListener("click", () => {
          gsap.fromTo(btn, { scale: 1 }, { scale: 0.85, duration: 0.1, yoyo: true, repeat: 1 });
        });
      });
      const diceBtn = document.getElementById("mode-both");
      if (diceBtn) {
        diceBtn.addEventListener("click", () => {
          gsap.fromTo(diceBtn, { rotation: -5 }, { rotation: 5, duration: 0.08, yoyo: true, repeat: 5 });
        });
      }
    });
    
    // Funktion zum Generieren einer neuen Serie erwarteter Noten.
    function generateSeries() {
      lastStartTime = Date.now();
      currentSeries = [];
      seriesCounter = 0;
      // Bestimme seriesLength basierend auf level
      if (level === 1) {
        seriesLength = 1;
      } else if (level === 2) {
        seriesLength = 5;
      } else if (level === 3) {
        seriesLength = 10;
      }
      var rangeNotes = ["c", "d", "e", "f", "g"];
      for (var i = 0; i < seriesLength; i++) {
        var randomIndex = Math.floor(Math.random() * rangeNotes.length);
        // Für diesen Test: Alle Noten in Oktave 4, Clef "treble"
        currentSeries.push({ note: rangeNotes[randomIndex], octave: 4, clef: "treble", color: "black" });
      }
      drawSeries();
    }
    
    // Zeichnet die aktuelle Notenserie mithilfe von VexFlow.
    function drawSeries() {
      var notationDiv = document.getElementById("notation");
      notationDiv.innerHTML = "";
      var usedWidth = 80 * seriesLength + 20;
      var renderer = new Vex.Flow.Renderer(notationDiv, Vex.Flow.Renderer.Backends.SVG);
      renderer.resize(usedWidth, 200);
      var context = renderer.getContext();
      var stave = new Vex.Flow.Stave(10, 40, usedWidth - 20);
      if (currentSeries.length > 0) {
        stave.addClef(currentSeries[0].clef).setContext(context).draw();
      }
      var staveNotes = currentSeries.map(function(item) {
        return new Vex.Flow.StaveNote({
          clef: item.clef,
          keys: [item.note + "/" + item.octave],
          duration: "q"
        }).setStyle({ fillStyle: item.color, strokeStyle: item.color });
      });
      var voice = new Vex.Flow.Voice({ num_beats: seriesLength, beat_value: 4 });
      staveNotes.forEach(function(note) { voice.addTickable(note); });
      new Vex.Flow.Formatter().joinVoices([voice]).format([voice], stave.getWidth() - 20);
      voice.draw(context, stave);
    }
  </script>

  <script>
    if (navigator.requestMIDIAccess) {
      navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
    }

    function onMIDISuccess(midiAccess) {
      const inputs = midiAccess.inputs.values();
      for (let input of inputs) {
        input.onmidimessage = handleMIDIMessageWeb;
      }
      console.log("MIDI ready");
    }

    function onMIDIFailure() {
      console.log("MIDI not available");
    }

    function handleMIDIMessageWeb(event) {
      const [status, data1, data2] = event.data;
      window.handleMIDIMessage(status, data1, data2);
    }
  </script>
</body>
</html>
